<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <title>CAV Explorer</title>
    <script charset="utf-8" src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>

<body>
    <div>
        <h1>Harmony CAV Explorer</h1>
        <div>
            Note that this site is <b>heavily under construction,</b> and more examples will be added!
            Currently only the results of T-CAV are shown for our ablated multi-task model.
        </div>
        <b>Instructions:</b>
        <ul>
            <li>Select a CAV and track using the dropdowns and play the audio using the player.</li>
            <li>Click notes on the heatmap to seek the audio to the corresponding position</li>
            <li>Tracks are listed according to <i>decreasing</i> sensitivity to the specified CAV.</li>
        </ul>
    </div>
    <div>
        <label>
            <b>CAV:</b>
            <select id="cavSelector" onchange="getTracks(this.value)">
                <option value="000" selected disabled hidden>Choose a CAV</option>
                <option value="000">1: Block Chords</option>
                <option value="001">2: Shell Voicings</option>
                <option value="002">3: Diatonic 7th Chords</option>
                <option value="003">4: Cycle Progressions</option>
                <option value="004">5: II-V-I's in Major and Minor</option>
                <option value="005">6: I-IV Cycle Progression</option>
                <option value="006">7: Modal Fourthy Voicings</option>
                <option value="007">8: So What Voicings</option>
                <option value="008">9: Modal "So What" Voicings</option>
                <option value="009">10: Fourth II-V-I's</option>
                <option value="010">11: Tri-Tone Sub II-V-I's</option>
                <option value="011">12: Polychordal II-V-I's</option>
                <option value="012">13: Cycling Altered Dominants</option>
                <option value="013">14: Polychordal Blues Voicings</option>
                <option value="014">15: Fourthy Blues Voicings</option>
                <option value="015">16: Major 7th Blues Voicings</option>
                <option value="016">17: Minor Blues Voicings</option>
                <option value="017">18: Dominant 7th Polychords</option>
                <option value="018">19: Dominant Polychord Groups</option>
                <option value="019">20: Diminished Substitutions</option>
            </select>
        </label>
        <label>
            <b>Track: </b>
            <select id="trackSelector" onchange="setTrack(this.value)">
                <option value="base" selected disabled hidden>Choose a track</option>
            </select>
        </label>
        <label>
            <b>Overall Sensitivity: </b>
            <label id="totalSens">UpdateMe</label>
        </label>
    </div>
    <div id="myDiv"></div>
    <div>
        <label>
            <b>MIDI Player: </b>
            <midi-player id="player"></midi-player>
        </label>
    </div>
    <div>
        <h3>Detailed explanation:</h3>
        A CAV is a <i>Concept Activation Vector</i>. Here, they were generated by:
        <ul>
            <li>Training a deep performer identification model on <i>chords</i> extracted from MIDI transcriptions</li>
            <li>Extracting MIDI from a textbook of jazz piano voicings</li>
            <li>Running this MIDI back into the model to extract embeddings</li>
            <li>Training binary classifiers (one per voicing type) to seperate embeddings from one voicing type from random other embeddings</li>
            <li>Taking the coefficients resulting from these classifiers as the CAV</li>
        </ul>
        Given a set of pieces <i>not used to update the weights of the model</i>:
        <ul>
            <li>The <b>overall sensitivity</b> with each CAV can be computed as the dot-product similarity between piece embeddings and CAV</li>
            <li>The <b>masked sensitivity</b> can be computed by sliding a kernel over the original MIDI and computing the similarity, as before</li>
        </ul>
        The heatmap shows the original MIDI piano roll, with the color showing the drop (or increase) in CAV sensitivity as particular notes are masked.
    </div>

    <script>
        function raiseErrors(msg, url, linenumber) {
            alert('Error message: '+msg+'\nURL: '+url+'\nLine Number: '+linenumber);
            return true;
        }

        window.onerror = raiseErrors

        function parseJson(jsName) {
            let request = new XMLHttpRequest();
            request.open("GET", jsName, false);
            request.send(null)
            return JSON.parse(request.responseText);
        }

        function getTracks(cavIdx) {
            let js = parseJson("similarity.json")
            let desiredTracks = js[cavIdx]
            let ts = document.getElementById("trackSelector")
            ts.innerHTML = ""
            for (var line = 0; line < desiredTracks.length; line++) {
                $("#trackSelector").append('<option value="' + desiredTracks[line] + '">' + desiredTracks[line] + '</option>');
            }
            setTrack()
        }

        function setTrack() {
            let clipPath = "data/" + document.getElementById("trackSelector").value.replaceAll('/', '_').replace('.mid', '')
            let cavNum = document.getElementById("cavSelector").value

            roll = parseJson(clipPath + "/roll.json")
            cav = parseJson(clipPath + "/cav_" + cavNum + ".json")
            // We use our little hack here to get the overall CAV sensitivity from the plotly json
            let overall_sensitivity = cav["overall"]
            updateOverallSensitivity(overall_sensitivity)

            layout = parseJson(clipPath + "/layout.json")
            layout.shapes = []

            hm = document.getElementById("myDiv")
            Plotly.newPlot('myDiv', [cav, roll], layout);

            player = document.getElementById("player")
            player.soundFont = 'https://storage.googleapis.com/magentadata/js/soundfonts/sgm_plus'
            player.src = clipPath + "/midi.mid"
            player.hidden = true
            hm.on('plotly_click', plotCallback);

            updateLine(0); // Start with the line at y=1
            setInterval(() => {
                const timeValue = player.currentTime;
                updateLine(timeValue * 100);
            }, 100);
        }

        function updateOverallSensitivity(t){
            document.getElementById("totalSens").innerText = t
        }

        function plotCallback(data){
            let pts = '';
            for(var i=0; i < data.points.length; i++){
                pts = data.points[i].x / 100
            }
            setTime(pts)
        }

        function setTime(time) {
            player.stop()
            player.currentTime = time
            player.start()
            updateLine(time * 100)
        }

        function updateLine(xValue) {
           layout.shapes = [{
                type: 'line',
                x0: xValue,
                x1: xValue,
                y0: 0,
                y1: 88,
                line: {
                    color: 'yellow',
                    width: 2
                }
            }];
            Plotly.react('myDiv', [cav, roll], layout);
        }
        getTracks("000")
    </script>
</body>
</html>
